{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h2 class="fw-bold text-secondary mb-0">Сетевые подключения</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-primary shadow-sm d-flex align-items-center gap-1" onclick="fetchConnections()" style="border-radius: 8px;">
            <span class="material-symbols-outlined fs-6">refresh</span> Обновить список
        </button>
    </div>
</div>

<!-- Вкладки (Tabs) с исправленными цветами иконок -->
<ul class="nav nav-pills mb-3 bg-white p-2 shadow-sm" id="connTabs" role="tablist" style="border-radius: 12px; display: inline-flex;">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold px-4 d-flex align-items-center gap-2" data-bs-toggle="tab" data-bs-target="#tab-inbound" type="button" role="tab">
            <!-- Иконка наследует цвет текста кнопки -->
            <span class="material-symbols-outlined">download</span> Входящие (Клиенты)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold px-4 d-flex align-items-center gap-2" data-bs-toggle="tab" data-bs-target="#tab-outbound" type="button" role="tab">
            <span class="material-symbols-outlined">upload</span> Исходящие (Сайты)
        </button>
    </li>
</ul>

<div class="tab-content">
    
    <!-- ВКЛАДКА: ВХОДЯЩИЕ -->
    <div class="tab-pane fade show active" id="tab-inbound" role="tabpanel">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle mb-0 text-nowrap">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 100px;">Статус</th>
                                <th>IP Адрес</th>
                                <th>Имя пользователя</th>
                                <th class="text-center">Соединения</th>
                                <th>Ограничение скорости</th>
                                <th class="pe-4 text-end">Действие</th>
                            </tr>
                        </thead>
                        <tbody id="inboundTableBody">
                            <tr><td colspan="6" class="text-center py-4 text-muted">Загрузка данных...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ВКЛАДКА: ИСХОДЯЩИЕ -->
    <div class="tab-pane fade" id="tab-outbound" role="tabpanel">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle mb-0 text-nowrap">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Целевой IP / Домен</th>
                                <th>Кто обращается</th>
                                <th class="pe-4 text-center">Кол-во соединений</th>
                            </tr>
                        </thead>
                        <tbody id="outboundTableBody">
                            <tr><td colspan="3" class="text-center py-4 text-muted">Загрузка данных...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- МОДАЛКИ (Лимит + Смена имени + Инфо об IP) -->
<div class="modal fade" id="limitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Ограничить скорость</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <p class="text-muted small">Установите лимит скачивания для IP: <strong id="modalIpText" class="text-dark"></strong></p>
                <div class="input-group mb-3">
                    <input type="number" id="speedInput" class="form-control" placeholder="Например: 5" min="1">
                    <span class="input-group-text">Мбит/с</span>
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="applyLimit()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="nameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Имя клиента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <p class="text-muted small">Задайте понятное имя для IP: <strong id="modalNameIpText" class="text-dark font-monospace"></strong></p>
                <input type="text" id="nameInput" class="form-control" placeholder="Например: ПК Ивана">
                <small class="text-muted d-block mt-2">Оставьте пустым, чтобы сбросить имя.</small>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="applyCustomName()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ipInfoModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Информация об IP</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center pt-2">
                <h4 class="font-monospace text-primary mb-3" id="infoIpText">8.8.8.8</h4>
                <div id="ipInfoLoader" class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div>
                <div id="ipInfoContent" style="display: none; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p class="mb-1"><strong>Страна:</strong> <span id="infoCountry"></span></p>
                    <p class="mb-1"><strong>Город:</strong> <span id="infoCity"></span></p>
                    <p class="mb-1"><strong>Провайдер:</strong> <span id="infoIsp"></span></p>
                    <p class="mb-0"><strong>Организация:</strong> <span id="infoOrg"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/vpn_users.js"></script>
{% endblock %}